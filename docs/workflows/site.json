{
  "nodes": [
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "09db48f1-b99e-4760-8a9b-10944a1ce0d2",
              "name": "texto",
              "value": "={{ $('Webhook').item.json.body.data.message.extendedTextMessage?.text ?? $('Webhook').item.json.body.data.message.conversation }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "03cedec5-8b6e-4f27-8cad-8db222892a96",
      "name": "edit2",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1296,
        1168
      ]
    },
    {
      "parameters": {
        "amount": 1
      },
      "id": "a4b273ec-aba2-497e-bfb5-af3df4ea1fb4",
      "name": "Wait",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        2320,
        752
      ],
      "webhookId": "e41c93ee-a926-43db-a345-700f4c59ee63"
    },
    {
      "parameters": {
        "operation": "get",
        "propertyName": "mensagem",
        "key": "={{ $('config').item.json.remoteJid }}",
        "options": {}
      },
      "id": "c1785313-bbac-43dc-be4c-443fa2f560cb",
      "name": "Puxar as Mensagens",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        2480,
        752
      ],
      "credentials": {
        "redis": {
          "id": "KsFe08lVHiyqdZgr",
          "name": "TirzepaLife - Site"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "id": "9e9b4155-e399-4936-a5db-2d79c8cb871f",
              "leftValue": "={{ $json.mensagem.last() }}",
              "rightValue": "={{ $('mensagem_cliente_inicial').item.json.texto }}",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "fdd2abdf-161f-43dd-a47e-54b9e88af790",
      "name": "If1",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        2640,
        752
      ]
    },
    {
      "parameters": {
        "operation": "delete",
        "key": "={{ $('config').item.json.remoteJid }}"
      },
      "id": "e8deff34-6afe-4add-a098-97d2a2e001bb",
      "name": "Redis",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        3008,
        736
      ],
      "credentials": {
        "redis": {
          "id": "KsFe08lVHiyqdZgr",
          "name": "TirzepaLife - Site"
        }
      }
    },
    {
      "parameters": {
        "operation": "push",
        "list": "={{ $('config').item.json.remoteJid }}",
        "messageData": "={{ $json.texto }}",
        "tail": true
      },
      "id": "9bf94ca1-e796-45a4-8df6-2f6a4b720f94",
      "name": "Lista Mensagens1",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        2160,
        752
      ],
      "credentials": {
        "redis": {
          "id": "KsFe08lVHiyqdZgr",
          "name": "TirzepaLife - Site"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "bce70488-3d4e-412d-9c28-4858906bc722",
              "name": "texto",
              "value": "={{ $('Puxar as Mensagens').item.json.mensagem.join('\\n') }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "3058c01c-47bc-4352-b841-a600c2bd3274",
      "name": "Edit Fields2",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2816,
        736
      ]
    },
    {
      "parameters": {
        "content": "## Buffer Redis - Mensagem picotada",
        "height": 80,
        "width": 875,
        "color": 3
      },
      "id": "6b7bd02b-f729-4927-ad54-e9c2e0c64dc5",
      "name": "Sticky Note3",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        1264,
        576
      ]
    },
    {
      "parameters": {
        "operation": "toBinary",
        "sourceProperty": "base64",
        "options": {}
      },
      "id": "51e01e2c-0869-4b3a-99c9-61f5427e33bf",
      "name": "Convert to File1",
      "type": "n8n-nodes-base.convertToFile",
      "typeVersion": 1.1,
      "position": [
        1456,
        752
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "f553042c-39d5-4bdd-8082-fbd390726fcd",
              "name": "base64",
              "value": "={{ $(\"Webhook\").item.json.body.data.message.base64 }}",
              "type": "string"
            },
            {
              "id": "99bfd97a-4868-47ad-bba4-54b3ff1df3bf",
              "name": "prompt",
              "value": "={{ $('Webhook').item.json.body.data.message?.imageMessage?.caption || \"Extraia todo o texto desta imagem. Apenas retorne o texto extraido.\" }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "d4033158-25d1-4771-9aea-1502176c1f2d",
      "name": "base",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1312,
        752
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "e1fdbe70-0c0e-46a1-accd-a79f4fd17098",
              "name": "texto",
              "value": "={{ $('base').item.json.prompt }}: {{ $json.content }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "d4a7cdaa-9cd8-4dd7-a672-7cf39b7c53ad",
      "name": "Edit Fields",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1744,
        752
      ]
    },
    {
      "parameters": {
        "resource": "image",
        "operation": "analyze",
        "modelId": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "GPT-4O-MINI"
        },
        "text": "={{ $('base').item.json.prompt }}",
        "inputType": "base64",
        "options": {}
      },
      "id": "1008ecbb-b972-4b7c-8d6d-b0989c8683e5",
      "name": "OpenAI1",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.6,
      "position": [
        1600,
        752
      ],
      "credentials": {
        "openAiApi": {
          "id": "tl4tpHLIujOLXC8p",
          "name": "ProceX AI - Interno"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "91ee1ece-f423-45ee-b628-906df8a36da4",
              "name": "remoteJid",
              "value": "={{ $('Webhook').item.json.body.data.key.remoteJid }}",
              "type": "string"
            },
            {
              "id": "c9ed0236-5ff7-4663-8d4e-596ff3738a75",
              "name": "id",
              "value": "={{ $('Webhook').item.json.body.data.key.id }}",
              "type": "string"
            },
            {
              "id": "e132ceaf-3444-4552-b3e8-ba0b0471d34f",
              "name": "mensagem",
              "value": "={{ $('Webhook').item.json.body.data.message.conversation }}",
              "type": "string"
            },
            {
              "id": "dec05903-a892-41ee-a327-8e47b381b2ab",
              "name": "messageType",
              "value": "={{ $('Webhook').item.json.body.data.messageType }}",
              "type": "string"
            },
            {
              "id": "9e1bf796-b4f6-43b7-bd91-92fbc254e16b",
              "name": "objetivo",
              "value": "={{ $('Webhook').item.json.body.data.client_context.triage.objetivo }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1056,
        688
      ],
      "id": "d59e45c6-8cab-4088-aaa0-f7c8b4298d77",
      "name": "config"
    },
    {
      "parameters": {
        "content": "## Configura√ß√£o",
        "height": 220,
        "width": 170
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -2032,
        496
      ],
      "id": "955446cf-238a-4bc6-a917-419ccca64fec",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "465ce541-a4d5-49cd-85ec-58e5449492cb",
              "name": "texto",
              "value": "={{ $json.texto }}",
              "type": "string"
            },
            {
              "id": "0555c824-bc2b-472b-a4c6-7b48bfc5cdec",
              "name": "id",
              "value": "={{ $('config').item.json.id }}",
              "type": "string"
            },
            {
              "id": "6a0af011-bcb7-4ff0-b1d7-4bb28260a85f",
              "name": "numeroCliente",
              "value": "={{ $('config').item.json.remoteJid }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        3632,
        608
      ],
      "id": "ab60b4d9-0ff9-4c79-ac71-e166f2e0fa37",
      "name": "mensagem_cliente"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "60d6b895-fea6-4d7f-932a-b8771c97242e",
              "name": "texto",
              "value": "={{ $json.texto || '' }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "d1826b3e-12d9-4cc4-a41b-75aaaa20fbb1",
      "name": "mensagem_cliente_inicial",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1968,
        752
      ]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Webhook').item.json.body.data.messageType }}",
                    "rightValue": "audioMessage",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "2b6e2d76-c1e8-4639-b910-adb228cd6289"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "audio"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "4a719a6f-b912-48ec-81a5-920afde042b6",
                    "leftValue": "={{ $('Webhook').item.json.body.data.messageType }}",
                    "rightValue": "imageMessage",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "imagem"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "50c6e2b0-2494-4780-abd8-84a0e4213091",
                    "leftValue": "={{ $('Webhook').item.json.body.data.messageType }}",
                    "rightValue": "conversation",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "texto"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "321a77de-69a3-4242-9172-c384f5bb931e",
                    "leftValue": "={{ $('Webhook').item.json.body.data.messageType }}",
                    "rightValue": "extendedTextMessage",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "texto2"
            }
          ]
        },
        "options": {}
      },
      "id": "c363b68f-9f6f-4ac1-bda3-5e827cabc4bc",
      "name": "mensagem_tipo",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        176,
        768
      ],
      "alwaysOutputData": false
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('Webhook').item.json.body.server_url }}/chat/getBase64FromMediaMessage/{{ $('Webhook').item.json.body.instance }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{ $('Webhook').item.json.body.apikey }}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"message\": {\n    \"key\": {\n      \"id\": \"{{ $('Webhook').item.json.body.data.key.id }}\"\n    }\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        928,
        448
      ],
      "id": "478ffa03-8a07-4a4a-bd6b-f6ae0acefb4a",
      "name": "Baixar √Åudio da URL"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.groq.com/openai/v1/audio/transcriptions",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "={{ $('config').item.json.groqApiKey }}"
            },
            {
              "name": "Content-type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "multipart-form-data",
        "bodyParameters": {
          "parameters": [
            {
              "name": "model",
              "value": "whisper-large-v3"
            },
            {
              "name": "temperature",
              "value": "0"
            },
            {
              "name": "response_format",
              "value": "json"
            },
            {
              "name": "language",
              "value": "pt"
            },
            {
              "parameterType": "formBinaryData",
              "name": "file",
              "inputDataFieldName": "data"
            }
          ]
        },
        "options": {}
      },
      "id": "c4e1921d-df82-4a69-bc50-1643c8356bce",
      "name": "Whisper2",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1376,
        448
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "7066ff08-1370-464f-a588-86aa37025523",
              "name": "texto",
              "value": "={{ $json.message.content }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "6b09ba48-c761-42cd-bbf3-250f1b0b2add",
      "name": "edit",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1824,
        448
      ],
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "operation": "toBinary",
        "sourceProperty": "base64",
        "options": {}
      },
      "type": "n8n-nodes-base.convertToFile",
      "typeVersion": 1.1,
      "position": [
        1136,
        448
      ],
      "id": "e4ef2ed3-807c-473a-949d-1358d3c2443d",
      "name": "Convert to File2"
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4.1-mini",
          "mode": "list",
          "cachedResultName": "GPT-4.1-MINI"
        },
        "messages": {
          "values": [
            {
              "content": "={{ $json.text }}"
            },
            {
              "content": "=Voc√™ √© um agente de limpeza de transcri√ß√£o. Sua √∫nica fun√ß√£o √© receber uma transcri√ß√£o de √°udio e organiz√°-la.\n\nSeu objetivo √© tornar a solicita√ß√£o mais clara, organizada e objetiva, mantendo **100% do conte√∫do original** e sem adicionar informa√ß√µes novas.\n\nAjuste a pontua√ß√£o, corrija pequenos erros de transcri√ß√£o e remova repeti√ß√µes ou v√≠cios de linguagem que s√£o comuns na fala.\n\nA sua sa√≠da deve conter **apenas a transcri√ß√£o limpa**. N√£o adicione sauda√ß√µes, frases como \"entendi sua solicita√ß√£o\", \"aqui est√° a transcri√ß√£o organizada\" ou qualquer tipo de metadado.\n\nA sa√≠da deve ser uma transcri√ß√£o √∫nica, coesa e pronta para ser processada por outros agentes."
            }
          ]
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        1504,
        448
      ],
      "id": "3efcc6ce-a612-4ad1-a1d9-ac454e0afee8",
      "name": "OpenAI",
      "credentials": {
        "openAiApi": {
          "id": "tl4tpHLIujOLXC8p",
          "name": "ProceX AI - Interno"
        }
      }
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "TizerpaLife",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -1952,
        496
      ],
      "id": "8644c561-df69-45f6-815e-78cb18b172b5",
      "name": "Webhook",
      "webhookId": "491975ba-0c77-445e-b54c-cf6c648e7b29"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.texto }}",
        "options": {
          "systemMessage": "=",
          "returnIntermediateSteps": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        3840,
        608
      ],
      "id": "3eb8ad6d-6af4-4284-8574-89450f53abf6",
      "name": "AI Agent"
    },
    {
      "parameters": {
        "model": "deepseek/deepseek-v3.2",
        "options": {
          "temperature": 0.3
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        3712,
        816
      ],
      "id": "06a7c565-b987-494e-8bf9-2271d555b2ea",
      "name": "OpenRouter Chat Model",
      "credentials": {
        "openRouterApi": {
          "id": "ssrtde89Aai4EcNA",
          "name": "Ticket Imediato"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('mensagem_cliente').item.json.numeroCliente }}",
        "tableName": "=langchain_chat_histories"
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        3856,
        816
      ],
      "id": "405a6835-df18-4111-ac73-fc52ac02910e",
      "name": "Postgres Chat Memory",
      "credentials": {
        "postgres": {
          "id": "cdb7mHNUiWEkaZJ7",
          "name": "LF@GMAIL - Testes"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        6336,
        224
      ],
      "id": "b9ed1db8-7d39-435a-843b-5fe0b9e171d9",
      "name": "Respond to Webhook"
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "=Utilize esta ferramenta para registrar ou atualizar dados de clientes no banco de dados ap√≥s coletar informa√ß√µes durante a conversa de qualifica√ß√£o.\n\nQUANDO USAR:\n- Ap√≥s coletar o n√∫mero de WhatsApp do cliente\n- Quando tiver informa√ß√µes suficientes da triagem (mesmo que parciais)",
        "operation": "executeQuery",
        "query": "INSERT INTO public.clientes (\n    nome,\n    telefone_whatsapp,\n    condicao_medica,\n    gestante_lactante,\n    historico_tireoide,\n    uso_anterior_glp1,\n    status_qualificacao,\n    dosagem_interesse,\n    origem,\n    atendido,\n    session_id,\n    created_at,\n    updated_at\n) VALUES (\n    $1, -- nome\n    $2, -- telefone_whatsapp (√∫nico)\n    $3, -- condicao_medica\n    $4, -- gestante_lactante\n    $5, -- historico_tireoide\n    $6, -- uso_anterior_glp1\n    'qualificado',\n    $7, -- dosagem_interesse\n    'formulario_site',\n    false,\n    $8, -- session_id\n    NOW(),\n    NOW()\n)\nON CONFLICT (telefone_whatsapp) DO UPDATE SET\n    updated_at = NOW(),\n    status_qualificacao = 'qualificado',\n    atendido = false,\n    session_id = EXCLUDED.session_id;\n",
        "options": {
          "queryReplacement": "={{ $fromAI(\"nome\") }},\n{{ $fromAI(\"telefone_whatsapp\") }},\n{{ $fromAI(\"condicao_medica\") }},\n{{ $fromAI(\"gestante_lactante\") }},\n{{ $fromAI(\"historico_tireoide\") }},\n{{ $fromAI(\"uso_anterior_glp1\") }},\n{{ $fromAI(\"dosagem_interesse\") }},\n{{ $json.numeroCliente }}"
        }
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        4000,
        816
      ],
      "id": "42578882-d8a7-421c-a4f3-d486cb0776ad",
      "name": "toolAtualizarDadosCliente",
      "credentials": {
        "postgres": {
          "id": "cdb7mHNUiWEkaZJ7",
          "name": "LF@GMAIL - Testes"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "b0050965-2b87-4265-b1bf-dc99205e1531",
              "name": "output",
              "value": "={{ $json.output }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        4208,
        624
      ],
      "id": "6867534a-1009-4e17-9484-4ca08f9c44ac",
      "name": "Texto Envio"
    },
    {
      "parameters": {
        "fieldToSplitOut": "text",
        "options": {}
      },
      "id": "9af8987e-9f08-4c99-9e7a-e5eaa5ab67c9",
      "name": "Split Out",
      "type": "n8n-nodes-base.splitOut",
      "typeVersion": 1,
      "position": [
        4768,
        624
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "a1e66db0-00dc-481d-951c-1fde558e268e",
              "name": "text",
              "value": "={{ (() => {\n  const maxLen = 280;\n  let raw = ($json.output ?? '').toString();\n  raw = raw.replace(/\\r\\n/g, '\\n').trim();\n\n  // Corrige \"√ìtimo!Tem\" -> \"√ìtimo! Tem\" (e similares)\n  raw = raw.replace(/([.!?])([^\\s\\n])/g, '$1 $2');\n\n  // 1) Respeita \\n\\n (formato do agente). Se n√£o tiver, tenta \\n. Se n√£o tiver, usa o texto todo.\n  let parts;\n  if (raw.includes('\\n\\n')) parts = raw.split(/\\n{2,}/);\n  else if (raw.includes('\\n')) parts = raw.split(/\\n+/);\n  else parts = [raw];\n\n  parts = parts.map(p => p.trim()).filter(Boolean);\n\n  const splitSentences = (text) => text\n    .replace(/([.!?])\\s+/g, '$1|')\n    .split('|')\n    .map(t => t.trim())\n    .filter(Boolean);\n\n  const chunkByWords = (text) => {\n    const words = text.split(/\\s+/).filter(Boolean);\n    const out = [];\n    let buf = '';\n    for (const w of words) {\n      const next = buf ? `${buf} ${w}` : w;\n      if (next.length > maxLen) {\n        if (buf) out.push(buf);\n        if (w.length > maxLen) {\n          for (let i = 0; i < w.length; i += maxLen) out.push(w.slice(i, i + maxLen));\n          buf = '';\n        } else {\n          buf = w;\n        }\n      } else {\n        buf = next;\n      }\n    }\n    if (buf) out.push(buf);\n    return out;\n  };\n\n  const out = [];\n\n  const pushChunked = (text) => {\n    if (!text) return;\n    if (text.length <= maxLen) {\n      out.push(text);\n      return;\n    }\n\n    const sentences = splitSentences(text);\n    if (sentences.length <= 1) {\n      chunkByWords(text).forEach(x => out.push(x));\n      return;\n    }\n\n    let buf = '';\n    for (const s of sentences) {\n      const next = buf ? `${buf} ${s}` : s;\n      if (next.length > maxLen) {\n        if (buf) out.push(buf);\n        if (s.length > maxLen) chunkByWords(s).forEach(x => out.push(x));\n        else buf = s;\n      } else {\n        buf = next;\n      }\n    }\n    if (buf) out.push(buf);\n  };\n\n  // Se veio tudo em 1 bloco grande, tenta quebrar por frases (melhora consist√™ncia)\n  if (parts.length === 1 && parts[0].length > 80) {\n    pushChunked(parts[0]);\n  } else {\n    parts.forEach(p => pushChunked(p));\n  }\n\n  return out.map(x => x.trim()).filter(Boolean);\n})() }}",
              "type": "array"
            }
          ]
        },
        "options": {}
      },
      "id": "769a92c7-afad-4710-a24c-fd0edc2668f8",
      "name": "Quebra da Resposta",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        4480,
        624
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "66e5c550-fef4-4210-935e-19be9d399211",
              "name": "delay",
              "value": "={{ Math.min(Math.max((($json.text ?? '').replace(/\\s+/g, '').length) * 50, 1500), 6000) + ($itemIndex * 2000) }}",
              "type": "number"
            },
            {
              "id": "text-field-preserve",
              "name": "text",
              "value": "={{ $json.text }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        5024,
        624
      ],
      "id": "1de8f884-2208-4b95-ac92-9b1ad73d7529",
      "name": "Tempo Digitacao 3"
    },
    {
      "parameters": {
        "aggregate": "aggregateAllItemData",
        "destinationFieldName": "messages",
        "include": "specifiedFields",
        "fieldsToInclude": "text,delay",
        "options": {}
      },
      "id": "98dafd10-7efe-4f1a-b63f-7f2c0dfa3a62",
      "name": "Aggregate Messages",
      "type": "n8n-nodes-base.aggregate",
      "typeVersion": 1,
      "position": [
        5328,
        624
      ]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.mensagem }}",
                    "rightValue": "__start__",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "start"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Webhook').item.json.body.data.form_id }}",
                    "rightValue": "qualificacao_inicial",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "qualificacao_form"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": true,
                    "rightValue": true,
                    "operator": {
                      "type": "boolean",
                      "operation": "equals"
                    },
                    "id": "2921ed2e-9651-4dda-a94d-9fdd0d0480bf"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "outros"
            }
          ]
        },
        "options": {}
      },
      "id": "2b286852-249e-4572-b89a-3becc96b035e",
      "name": "detectar_start",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -448,
        640
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "name": "messages",
              "value": "={{ (() => {\n  const tipo = $json.tipo_bloqueio;\n  \n  if (tipo === 'gestante') {\n    return [\n      { text: \"Obrigada por responder com sinceridade üíô\", delay: 1200 },\n      { text: \"Por seguran√ßa, a Tirzepatida n√£o √© recomendada durante a gesta√ß√£o ou amamenta√ß√£o, pois ainda n√£o h√° estudos suficientes sobre poss√≠veis efeitos.\", delay: 2500 },\n      { text: \"O ideal √© conversar com seu obstetra para avaliar alternativas seguras nesse momento. Se quiser, posso te ajudar com d√∫vidas sobre alimenta√ß√£o e h√°bitos saud√°veis!\", delay: 2200 }\n    ];\n  }\n  \n  if (tipo === 'tireoide') {\n    return [\n      { text: \"Obrigada por compartilhar isso comigo üíô\", delay: 1200 },\n      { text: \"Por precau√ß√£o m√©dica, quando h√° hist√≥rico pessoal ou familiar de c√¢ncer medular de tireoide ou NEM2, a Tirzepatida n√£o √© recomendada.\", delay: 2800 },\n      { text: \"Sugiro que voc√™ consulte um endocrinologista para uma avalia√ß√£o personalizada e segura. Se tiver outras d√∫vidas sobre sa√∫de metab√≥lica, estou aqui!\", delay: 2400 }\n    ];\n  }\n  \n  return [\n    { text: \"Obrigada por responder üíô\", delay: 1000 },\n    { text: \"Por seguran√ßa, preciso que voc√™ converse com um m√©dico antes de prosseguir.\", delay: 2000 }\n  ];\n})() }}",
              "type": "array",
              "id": "c072ed43-9beb-4e05-9c33-8772b4718b29"
            },
            {
              "id": "16a8190f-22c5-4dfa-9f77-7934240863b6",
              "name": "desqualificado",
              "value": "desqualificado",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "6681307f-7051-45d4-a6da-f3e47c6498f4",
      "name": "mensagem_desqualificacao",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1120,
        656
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "1cc3d3f5-63ed-4653-b445-5c599320235b",
              "name": "messages",
              "value": "={{ [\n  { text: \"Ol√°! Sou a Dra. Ana, consultora da TirzepaLife üòä\", delay: 1000 },\n  { text: \"Para te orientar com seguran√ßa, preciso fazer algumas perguntas r√°pidas sobre sua sa√∫de.\", delay: 1800 },\n  { text: \"S√£o apenas 4 perguntas e leva menos de 1 minuto!\", delay: 1500 }\n] }}",
              "type": "array"
            },
            {
              "name": "ui",
              "value": {
                "type": "form_card",
                "id": "qualificacao_inicial",
                "title": "Question√°rio de Elegibilidade",
                "description": "Para sua seguran√ßa, preciso fazer algumas perguntas r√°pidas antes de prosseguir.",
                "submitLabel": "Enviar Respostas",
                "fields": [
                  {
                    "name": "gestante_lactante",
                    "label": "Voc√™ est√° gr√°vida ou amamentando?",
                    "type": "single_select",
                    "required": true,
                    "options": [
                      {
                        "value": "sim",
                        "label": "Sim"
                      },
                      {
                        "value": "nao",
                        "label": "N√£o"
                      }
                    ]
                  },
                  {
                    "name": "historico_tireoide",
                    "label": "Voc√™ ou algu√©m da sua fam√≠lia teve c√¢ncer medular de tireoide ou NEM2?",
                    "type": "single_select",
                    "required": true,
                    "helperText": "NEM2 = Neoplasia End√≥crina M√∫ltipla tipo 2",
                    "options": [
                      {
                        "value": "sim",
                        "label": "Sim"
                      },
                      {
                        "value": "nao",
                        "label": "N√£o"
                      },
                      {
                        "value": "nao_sei",
                        "label": "N√£o sei"
                      }
                    ]
                  },
                  {
                    "name": "uso_anterior_glp1",
                    "label": "Voc√™ j√° usou algum medicamento similar antes?",
                    "type": "single_select",
                    "required": true,
                    "helperText": "Ex.: Ozempic, Saxenda, Wegovy, Victoza",
                    "options": [
                      {
                        "value": "ozempic",
                        "label": "Sim, Ozempic"
                      },
                      {
                        "value": "saxenda",
                        "label": "Sim, Saxenda"
                      },
                      {
                        "value": "wegovy",
                        "label": "Sim, Wegovy"
                      },
                      {
                        "value": "outro",
                        "label": "Sim, outro"
                      },
                      {
                        "value": "nao",
                        "label": "N√£o"
                      }
                    ]
                  },
                  {
                    "name": "objetivo",
                    "label": "Qual √© o seu objetivo principal?",
                    "type": "single_select",
                    "required": true,
                    "options": [
                      {
                        "value": "emagrecimento",
                        "label": "Emagrecimento"
                      },
                      {
                        "value": "apetite",
                        "label": "Controle de apetite"
                      },
                      {
                        "value": "metabolico",
                        "label": "Controle metab√≥lico"
                      },
                      {
                        "value": "saude",
                        "label": "Melhorar sa√∫de geral"
                      }
                    ]
                  }
                ]
              },
              "type": "object",
              "id": "768671d7-5712-40fb-93b6-bf247293c92b"
            }
          ]
        },
        "options": {}
      },
      "id": "2a3491d6-1eba-49e4-997e-52254dc672c6",
      "name": "resposta_start_com_form1",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        880,
        80
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "06584ba2-24cc-4e7a-ae06-35ef58e3deda",
              "leftValue": "={{ $('Webhook').item.json.body.data.client_context.triage.gestante_lactante }}",
              "rightValue": "nao",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            },
            {
              "id": "05a651f8-2776-4c14-9d27-489f5ad059b2",
              "leftValue": "={{ $('Webhook').item.json.body.data.client_context.triage.historico_tireoide }}",
              "rightValue": "nao",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            },
            {
              "id": "769d75b5-cb8c-446c-bd7b-b2cca3c85644",
              "leftValue": "={{ $('Webhook').item.json.body.data.client_context.triage.uso_anterior_glp1 }}",
              "rightValue": "nao",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        720,
        656
      ],
      "id": "8c3a7969-896d-4c06-a8f9-ff41beb74890",
      "name": "If"
    },
    {
      "parameters": {
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "clientes",
          "mode": "list",
          "cachedResultName": "clientes"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "status_qualificacao": "={{ $json.desqualificado }}",
            "created_at": "={{ $now }}",
            "origem": "={{ $('Webhook').item.json.body.data.source }}",
            "session_id": "={{ $('Webhook').item.json.body.data.client_context.session_id }}"
          },
          "matchingColumns": [
            "session_id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "nome",
              "displayName": "nome",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "telefone_whatsapp",
              "displayName": "telefone_whatsapp",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "condicao_medica",
              "displayName": "condicao_medica",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "gestante_lactante",
              "displayName": "gestante_lactante",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "historico_tireoide",
              "displayName": "historico_tireoide",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "uso_anterior_glp1",
              "displayName": "uso_anterior_glp1",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "status_qualificacao",
              "displayName": "status_qualificacao",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "dosagem_interesse",
              "displayName": "dosagem_interesse",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "origem",
              "displayName": "origem",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "observacoes",
              "displayName": "observacoes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "asaas_payment_id",
              "displayName": "asaas_payment_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "asaas_status",
              "displayName": "asaas_status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "asaas_link_pagamento",
              "displayName": "asaas_link_pagamento",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "cpf",
              "displayName": "cpf",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        1536,
        608
      ],
      "id": "5eb59850-fd48-4ab4-a85a-2a8d14fcac50",
      "name": "Insert rows in a table",
      "credentials": {
        "postgres": {
          "id": "cdb7mHNUiWEkaZJ7",
          "name": "LF@GMAIL - Testes"
        }
      }
    },
    {
      "parameters": {
        "operation": "select",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "clientes",
          "mode": "list",
          "cachedResultName": "clientes"
        },
        "limit": 1,
        "where": {
          "values": [
            {
              "column": "status_qualificacao",
              "value": "desqualificado"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -1712,
        528
      ],
      "id": "a5363003-9d81-4079-9dec-c9c9abce9e2e",
      "name": "Select rows from a table",
      "credentials": {
        "postgres": {
          "id": "cdb7mHNUiWEkaZJ7",
          "name": "LF@GMAIL - Testes"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "f13f43e6-29cf-47c8-9132-aa7aec63bfae",
              "leftValue": "={{ $json.status_qualificacao }}",
              "rightValue": "desqualificado",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1504,
        528
      ],
      "id": "91c52a44-cd60-4298-bed2-8f1694c518c4",
      "name": "If2"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        -1136,
        512
      ],
      "id": "4b46fed7-1fe7-48d8-9583-aca0cbbe47d6",
      "name": "No Operation, do nothing"
    }
  ],
  "connections": {
    "edit2": {
      "main": [
        [
          {
            "node": "mensagem_cliente_inicial",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait": {
      "main": [
        [
          {
            "node": "Puxar as Mensagens",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Puxar as Mensagens": {
      "main": [
        [
          {
            "node": "If1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If1": {
      "main": [
        [
          {
            "node": "Edit Fields2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Redis": {
      "main": [
        [
          {
            "node": "mensagem_cliente",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Lista Mensagens1": {
      "main": [
        [
          {
            "node": "Wait",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields2": {
      "main": [
        [
          {
            "node": "Redis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Convert to File1": {
      "main": [
        [
          {
            "node": "OpenAI1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "base": {
      "main": [
        [
          {
            "node": "Convert to File1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields": {
      "main": [
        [
          {
            "node": "mensagem_cliente_inicial",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI1": {
      "main": [
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "config": {
      "main": [
        [
          {
            "node": "detectar_start",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "mensagem_cliente": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "mensagem_cliente_inicial": {
      "main": [
        [
          {
            "node": "Lista Mensagens1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "mensagem_tipo": {
      "main": [
        [
          {
            "node": "Baixar √Åudio da URL",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "base",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "edit2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "edit2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Baixar √Åudio da URL": {
      "main": [
        [
          {
            "node": "Convert to File2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Whisper2": {
      "main": [
        [
          {
            "node": "OpenAI",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "edit": {
      "main": [
        [
          {
            "node": "mensagem_cliente_inicial",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Convert to File2": {
      "main": [
        [
          {
            "node": "Whisper2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI": {
      "main": [
        [
          {
            "node": "edit",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook": {
      "main": [
        [
          {
            "node": "Select rows from a table",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "Texto Envio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenRouter Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Postgres Chat Memory": {
      "ai_memory": [
        [
          {
            "node": "AI Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "toolAtualizarDadosCliente": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Texto Envio": {
      "main": [
        [
          {
            "node": "Quebra da Resposta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Out": {
      "main": [
        [
          {
            "node": "Tempo Digitacao 3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Quebra da Resposta": {
      "main": [
        [
          {
            "node": "Split Out",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tempo Digitacao 3": {
      "main": [
        [
          {
            "node": "Aggregate Messages",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aggregate Messages": {
      "main": [
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "detectar_start": {
      "main": [
        [
          {
            "node": "resposta_start_com_form1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "mensagem_tipo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "mensagem_desqualificacao": {
      "main": [
        [
          {
            "node": "Insert rows in a table",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "resposta_start_com_form1": {
      "main": [
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [],
        [
          {
            "node": "mensagem_desqualificacao",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Insert rows in a table": {
      "main": [
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Select rows from a table": {
      "main": [
        [
          {
            "node": "If2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If2": {
      "main": [
        [
          {
            "node": "No Operation, do nothing",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "config",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {
    "Webhook": [
      {
        "headers": {
          "host": "webh.procexai.tech",
          "user-agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/143.0.0.0 Safari/537.36",
          "content-length": "2048",
          "accept": "*/*",
          "accept-encoding": "gzip, deflate, br, zstd",
          "accept-language": "en-US,en;q=0.9,pt;q=0.8",
          "content-type": "application/json",
          "origin": "https://tirzepalife-lp-v2.vercel.app",
          "priority": "u=1, i",
          "referer": "https://tirzepalife-lp-v2.vercel.app/",
          "sec-ch-ua": "\"Google Chrome\";v=\"143\", \"Chromium\";v=\"143\", \"Not A(Brand\";v=\"24\"",
          "sec-ch-ua-mobile": "?0",
          "sec-ch-ua-platform": "\"Windows\"",
          "sec-fetch-dest": "empty",
          "sec-fetch-mode": "cors",
          "sec-fetch-site": "cross-site",
          "x-forwarded-for": "10.0.0.2",
          "x-forwarded-host": "webh.procexai.tech",
          "x-forwarded-port": "443",
          "x-forwarded-proto": "https",
          "x-forwarded-server": "d8cb359c9c09",
          "x-real-ip": "10.0.0.2"
        },
        "params": {},
        "query": {},
        "body": {
          "data": {
            "key": {
              "remoteJid": "web_303534850@s.whatsapp.net",
              "fromMe": false,
              "id": "1766639495205"
            },
            "pushName": "Visitante Web",
            "message": {
              "conversation": "oi["
            },
            "messageType": "conversation",
            "messageTimestamp": 1766639495,
            "instanceId": "web-client-integration",
            "source": "web",
            "client_context": {
              "session_id": "web_303534850",
              "triage_completed": true,
              "triage": {
                "gestante_lactante": "sim",
                "historico_tireoide": "sim",
                "uso_anterior_glp1": "ozempic",
                "objetivo": "metabolico"
              },
              "last_messages": [
                {
                  "sender": "ai",
                  "content": "Ol√°! Sou a Dra. Ana, consultora da TirzepaLife üòä",
                  "timestamp": 1766638641690
                },
                {
                  "sender": "ai",
                  "content": "Para te orientar com seguran√ßa, preciso fazer algumas perguntas r√°pidas sobre sua sa√∫de.",
                  "timestamp": 1766638643591
                },
                {
                  "sender": "ai",
                  "content": "S√£o apenas 4 perguntas e leva menos de 1 minuto!",
                  "timestamp": 1766638645193
                },
                {
                  "sender": "user",
                  "content": "Respondi a triagem ‚úÖ",
                  "timestamp": 1766638651465
                },
                {
                  "sender": "ai",
                  "content": "Obrigada por responder üíô",
                  "timestamp": 1766638652634
                },
                {
                  "sender": "ai",
                  "content": "Por seguran√ßa, preciso que voc√™ converse com um m√©dico antes de prosseguir.",
                  "timestamp": 1766638654736
                },
                {
                  "sender": "user",
                  "content": "por que",
                  "timestamp": 1766638661923
                },
                {
                  "sender": "ai",
                  "content": "Ol√°! Eu sou a Dra. Ana, consultora de sa√∫de da TirzepaLife.",
                  "timestamp": 1766638699584
                },
                {
                  "sender": "ai",
                  "content": "Entendo que voc√™ quer saber mais sobre o tratamento com Tirzepatida (Mounjaro).",
                  "timestamp": 1766638706581
                },
                {
                  "sender": "ai",
                  "content": "Para te orientar da melhor forma, voc√™ j√° preencheu a triagem inicial? Se sim, posso te ajudar com d√∫vidas espec√≠ficas ou te encaminhar para o especialista.",
                  "timestamp": 1766638718579
                },
                {
                  "sender": "ai",
                  "content": "Se ainda n√£o preencheu, vou precisar de algumas informa√ß√µes r√°pidas para entender se faz sentido voc√™ conversar com nosso especialista.",
                  "timestamp": 1766638731584
                },
                {
                  "sender": "user",
                  "content": "oi[",
                  "timestamp": 1766639495205
                }
              ],
              "page": {
                "path": "/",
                "url": "https://tirzepalife-lp-v2.vercel.app/"
              },
              "timestamp_ms": 1766639495206
            }
          },
          "sender": "web_303534850@s.whatsapp.net"
        },
        "webhookUrl": "https://webh.procexai.tech/webhook/TizerpaLife",
        "executionMode": "production"
      }
    ],
    "Select rows from a table": [
      {
        "id": 37,
        "nome": null,
        "telefone_whatsapp": null,
        "condicao_medica": null,
        "gestante_lactante": null,
        "historico_tireoide": null,
        "uso_anterior_glp1": null,
        "status_qualificacao": "desqualificado",
        "dosagem_interesse": null,
        "origem": "web",
        "observacoes": null,
        "created_at": "2025-12-25T00:05:23.897Z",
        "updated_at": "2025-12-25T05:05:23.964Z",
        "session_id": "web_303534850",
        "asaas_payment_id": null,
        "asaas_status": null,
        "asaas_link_pagamento": null,
        "cpf": null
      }
    ],
    "No Operation, do nothing": [
      {
        "id": 37,
        "nome": null,
        "telefone_whatsapp": null,
        "condicao_medica": null,
        "gestante_lactante": null,
        "historico_tireoide": null,
        "uso_anterior_glp1": null,
        "status_qualificacao": "desqualificado",
        "dosagem_interesse": null,
        "origem": "web",
        "observacoes": null,
        "created_at": "2025-12-25T00:05:23.897Z",
        "updated_at": "2025-12-25T05:05:23.964Z",
        "session_id": "web_303534850",
        "asaas_payment_id": null,
        "asaas_status": null,
        "asaas_link_pagamento": null,
        "cpf": null
      }
    ]
  },
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "2fecef58d6bf43cf9041f65ddaf87c0c9a49f94544940cb5ccf72b8259d7a6cd"
  }
}